# syntax=docker/dockerfile:1.7

############################################
# Base image ì„ íƒ (ì•„í‚¤í…ì²˜ ìë™ ë¶„ê¸°)
############################################
# FROM ubuntu:24.04
FROM osrf/ros:jazzy-desktop

# korean mirror
USER root
RUN sed -i 's/archive.ubuntu.com/mirror.kakao.com/g' /etc/apt/sources.list && \
    sed -i 's/security.ubuntu.com/mirror.kakao.com/g' /etc/apt/sources.list

############################################
# ê¸°ë³¸ í™˜ê²½ ì„¤ì •
############################################
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Seoul


############################################
# Locale ì„¤ì • (ROS í•„ìˆ˜)
############################################
# RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

# ğŸ”‘ Universe repo í™œì„±í™”
# RUN apt-get update && apt-get install -y \
#     software-properties-common \
#     && add-apt-repository universe \
#     && apt-get update

# [ì¶”ê°€] aptê°€ IPv4ë§Œ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •
RUN echo 'Acquire::ForceIPv4 "true";' > /etc/apt/apt.conf.d/99force-ipv4

RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
    curl \
    gnupg2 \
    lsb-release \
    ca-certificates \
    sudo \
    locales \
    git \
    build-essential \
    python3-pip \
    python3-colcon-common-extensions \
    ros-dev-tools \
    && rm -rf /var/lib/apt/lists/*


############################################
# ROS2 Jazzy ì €ì¥ì†Œ ë“±ë¡
############################################
# RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key \
#     -o /usr/share/keyrings/ros-archive-keyring.gpg

# RUN echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] \
#     http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" \
#     > /etc/apt/sources.list.d/ros2.list

############################################
# ROS2 Jazzy ì„¤ì¹˜
############################################
# RUN apt-get update && apt-get install -y \
#     ros-jazzy-desktop \
#     ros-dev-tools \
#     && rm -rf /var/lib/apt/lists/*

############################################
# 5. ì‚¬ìš©ì ì„¤ì • (Dev Container ê¶Œì¥ ì‚¬í•­)
############################################
ARG USERNAME=ubuntu
# Ubuntu 24.04 ì´ë¯¸ì§€ëŠ” 'ubuntu' ì‚¬ìš©ìê°€ ì´ë¯¸ ì¡´ì¬í•˜ë¯€ë¡œ sudo ê¶Œí•œë§Œ ì¶”ê°€
RUN echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/$USERNAME \
    && chmod 0440 /etc/sudoers.d/$USERNAME

############################################
# rosdep ì´ˆê¸°í™”
############################################
USER $USERNAME
RUN rosdep init || true
RUN rosdep update

############################################
# ROS í™˜ê²½ ìë™ source
############################################
# RUN echo "source /opt/ros/jazzy/setup.bash" >> /etc/bash.bashrc
RUN echo "source /opt/ros/jazzy/setup.bash" >> ~/.bashrc
RUN echo "source /usr/share/colcon_common_extensions/lexicon/argcomplete.bash" >> ~/.bashrc

############################################
# Jetson (ARM64) ì „ìš© ì²˜ë¦¬
############################################
ARG TARGETARCH
RUN if [ "$TARGETARCH" = "arm64" ]; then \
        echo "Jetson í™˜ê²½ ê°ì§€: ARM64 ìµœì í™” ì„¤ì •"; \
        apt-get update && apt-get install -y \
            nvidia-cuda-toolkit \
        || true; \
    fi

############################################
# 7. Jetson (ARM64) ì¶”ê°€ ì„¤ì • (ì„ íƒ ì‚¬í•­)
############################################
# ARG TARGETARCH
# RUN if [ "$TARGETARCH" = "arm64" ]; then \
#         sudo apt-get update && sudo apt-get install -y \
#         # Jetsonì—ì„œ í•„ìš”í•œ ì¶”ê°€ íŒ¨í‚¤ì§€ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì‘ì„± \
#         && sudo rm -rf /var/lib/apt/lists/*; \
#     fi


############################################
# ê¸°ë³¸ ì‘ì—… ë””ë ‰í† ë¦¬
############################################
WORKDIR /workspaces/ros2_ws

CMD [ "bash" ]
